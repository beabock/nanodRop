---
title: "Advanced Spectral Analysis with nanodRop"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Advanced Spectral Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(nanodRop)
library(ggplot2)
```

## Introduction

This vignette covers advanced usage of the `nanodRop` package, including custom wavelength analysis, statistical comparisons, and integration with other R packages for spectral analysis.

## Custom Wavelength Analysis

The `parse_waves()` function allows you to specify custom wavelength pairs for analysis:

```{r custom_waves}
# Load sample data
data <- read_nanodrop(system.file("extdata", "UV-Vis 5_14_2024 5_03_11 PM.tsv", package = "nanodRop"))

# Analyze multiple wavelength pairs
custom_pairs <- list(
  c(260, 280),  # DNA/RNA peaks
  c(300, 400),  # General UV absorption
  c(542, 644)   # Custom peaks
)

results <- parse_waves(data, wave_pairs = custom_pairs)
head(results)
```

## Statistical Analysis

Perform statistical comparisons between samples:

```{r stats}
# Calculate summary statistics for each sample
sample_stats <- data %>%
  group_by(samps) %>%
  summarise(
    mean_abs = mean(abs),
    max_abs = max(abs),
    wavelength_max = waves[which.max(abs)],
    auc = sum(abs)  # Area under curve approximation
  )

print(sample_stats)
```

## Visualization Techniques

Create informative plots of spectral data:

```{r plots}
# Spectral overlay plot
ggplot(data, aes(x = waves, y = abs, color = samps)) +
  geom_line(alpha = 0.7) +
  labs(x = "Wavelength (nm)", y = "Absorbance") +
  theme_minimal() +
  ggtitle("Spectral Comparison")

# Heatmap of absorbance across wavelengths
library(reshape2)
wide_data <- dcast(data, samps ~ waves, value.var = "abs")
melted_data <- melt(wide_data, id.vars = "samps")

ggplot(melted_data, aes(x = as.factor(Var2), y = samps, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(x = "Wavelength (nm)", y = "Sample", fill = "Absorbance") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Quality Control

Check data quality and identify potential issues:

```{r qc}
# Check for negative absorbance values
negative_abs <- data[data$abs < 0, ]
if(nrow(negative_abs) > 0) {
  warning("Negative absorbance values detected")
  print(negative_abs)
}

# Check wavelength range
wavelength_range <- range(data$waves)
print(paste("Wavelength range:", wavelength_range[1], "-", wavelength_range[2], "nm"))

# Sample completeness check
samples_per_wavelength <- table(data$waves)
incomplete_samples <- names(samples_per_wavelength[samples_per_wavelength != max(samples_per_wavelength)])
if(length(incomplete_samples) > 0) {
  warning("Incomplete wavelength data for some samples")
}
```

## Integration with Other Packages

Combine `nanodRop` with other spectroscopy packages:

```{r integration}
# Example with base R plotting
library(nanodRop)

# Smooth spectra using loess
smoothed <- data %>%
  group_by(samps) %>%
  mutate(smoothed_abs = predict(loess(abs ~ waves, span = 0.1)))

# Plot original vs smoothed
ggplot(smoothed, aes(x = waves)) +
  geom_line(aes(y = abs, color = "Original")) +
  geom_line(aes(y = smoothed_abs, color = "Smoothed")) +
  facet_wrap(~samps) +
  labs(x = "Wavelength (nm)", y = "Absorbance") +
  theme_minimal()
```

## Batch Processing

Process multiple files in batch:

```{r batch}
# List all TSV files in a directory
# file_list <- list.files(path = "data/", pattern = "*.tsv", full.names = TRUE)

# Process multiple files (example with single file)
batch_results <- list()
# for(file in file_list) {
  file <- system.file("extdata", "UV-Vis 5_14_2024 5_03_11 PM.tsv", package = "nanodRop")
  batch_results[[basename(file)]] <- read_nanodrop(file)
# }

# Combine results
combined_data <- bind_rows(batch_results, .id = "file")
print(table(combined_data$file, combined_data$samps))
```

## Troubleshooting Common Issues

### Missing Wavelengths

```{r troubleshoot}
# Check if expected wavelengths are present
expected_waves <- seq(190, 850, by = 0.5)
missing_waves <- setdiff(expected_waves, unique(data$waves))

if(length(missing_waves) > 0) {
  message("Missing wavelengths: ", paste(missing_waves, collapse = ", "))
} else {
  message("All expected wavelengths present")
}
```

### Sample Naming Issues

```{r sample_names}
# Clean sample names if needed
data_clean <- data %>%
  mutate(samps = str_trim(samps))  # Remove extra whitespace

unique(data_clean$samps)
```

## Conclusion

This advanced vignette has covered:

- Custom wavelength pair analysis
- Statistical summaries and comparisons
- Multiple visualization approaches
- Quality control procedures
- Integration with other R packages
- Batch processing workflows
- Common troubleshooting scenarios

These techniques should help you get the most out of your NanoDrop spectral data using the `nanodRop` package.